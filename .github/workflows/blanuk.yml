name: Replace Kernel in boot.img from AK3 Package

on:
  workflow_dispatch:
    inputs:
      boot_img_url:
        description: "URL to download the boot.img file"
        required: true
        type: string
      ak3_url:
        description: "URL to download the AK3 package"
        required: true
        type: string

jobs:
  replace-kernel:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Download boot.img
        run: |
          curl -L -o boot.img "${{ github.event.inputs.boot_img_url }}"
          if [ ! -f "boot.img" ]; then
            echo "Failed to download boot.img. Exiting."
            exit 1
          fi

      - name: Download AK3 Package
        run: |
          curl -L -o ak3_package.zip "${{ github.event.inputs.ak3_url }}"
          unzip ak3_package.zip -d ak3_folder
          echo "AK3 Package contents:"
          ls ak3_folder

      - name: Extract Image.gz
        run: |
          # 解压 Image.gz 文件
          if [ -f "ak3_folder/Image.gz" ]; then
            echo "Extracting Image.gz..."
            gunzip ak3_folder/Image.gz
          else
            echo "Image.gz not found!"
            exit 1
          fi
          # 确保解压后的 Image 文件存在
          kernel_file="ak3_folder/Image"
          if [ ! -f "$kernel_file" ]; then
            echo "Kernel file does not exist after extraction: $kernel_file"
            exit 1
          fi
          
      - name: Unpack boot.img
        run: |
          chmod +x magiskboot
          ./magiskboot unpack boot.img

      - name: Replace Kernel in boot.img
        run: |
          echo "Replacing kernel in boot.img with ${kernel_file}"
          cp "${kernel_file}" unpacked/boot.img.kernel

      - name: Repack boot.img
        run: |
          ./magiskboot repack unpacked/boot.img
          if [ ! -f "new_boot.img" ]; then
            echo "Failed to repack boot.img. Exiting."
            exit 1
          fi

      # Optionally: Upload the new boot.img somewhere or deploy it to a device
